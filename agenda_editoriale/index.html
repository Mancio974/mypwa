<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Consulente Editoriale PWA</title>
<link rel="manifest" href="manifest.webmanifest" />
<style>
  /* Tema scuro semplice */
  body {
    margin: 0; 
    font-family: Arial, sans-serif;
    background-color: #121212;
    color: #e0e0e0;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  header {
    background: #1f1f1f;
    padding: 1rem;
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
  }
  nav {
    display: flex;
    justify-content: space-around;
    background: #222;
    padding: 0.5rem 0;
    position: fixed;
    bottom: 0;
    width: 100%;
    z-index: 100;
  }
  nav button {
    background: none;
    border: none;
    color: #e0e0e0;
    font-size: 1rem;
    cursor: pointer;
    padding: 0.5rem;
  }
  nav button.active {
    border-top: 2px solid #D6D58E;
    color: #D6D58E;
  }
  main {
    padding: 1rem;
    padding-bottom: 3.5rem; /* spazio per nav */
  }
  section {
    display: none;
  }
  section.active {
    display: block;
  }
  h2 {
    border-bottom: 1px solid #333;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    color: #327355;
  }
  input, select, textarea, button {
    width: 100%;
    margin-bottom: 0.7rem;
    padding: 0.6rem;
    border-radius: 3px;
    border: none;
    background: #222;
    color: #e0e0e0;
    box-sizing: border-box;
    font-size: 1rem;
  }
  button.primary {
    background-color: #67734F;
    color: white;
    border: none;
  }
  button.danger {
    background-color: #591C21;
    color: white;
    border: none;
  }
  .list-item {
    background: #1b1b1b;
    padding: 0.8rem;
    margin-bottom: 0.6rem;
    border-radius: 4px;
  }
  .item-actions {
    margin-top: 0.3rem;
    display: flex;
    gap: 0.5rem;
  }
  label {
    font-weight: bold;
  }
  /* Layout per form ed elenco */
  .flex-row {
    display: flex;
    gap: 0.5rem;
  }
  .flex-row > * {
    flex: 1;
  }
  /* Filtro in rubrica */
  #filter-category {
    margin-bottom: 1rem;
}
/* Aggiungi queste regole al CSS esistente */
.export-import-container {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: #1b1b1b;
  border-radius: 4px;
}

.export-import-buttons {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.export-import-buttons button {
  flex: 1;
  background-color: #327355;
  color: white;
  border: none;
  padding: 0.6rem;
  border-radius: 3px;
  cursor: pointer;
  font-size: 0.9rem;
}

.export-import-buttons button:hover {
  background-color: #3d8a66;
}

#import-file {
  display: none;
}

.import-label {
  display: block;
  background-color: #67734F;
  color: white;
  text-align: center;
  padding: 0.6rem;
  border-radius: 3px;
  cursor: pointer;
  margin-bottom: 0.7rem;
}

.import-label:hover {
  background-color: #7a8659;
}
</style>
</head>
<body>
<header>Agenda per Consulenti Editoriali</header>
<nav>
  <button id="tab-calendar" class="active">Calendario</button>
  <button id="tab-contacts">Rubrica</button>
  <button id="tab-jobs">Progetti</button>
</nav>
<main>
<!-- Container per Export/Import - DA AGGIUNGERE QUI -->
  <div class="export-import-container">
    <h3 style="margin-top: 0; color: #327355; font-size: 1rem;">Gestione Dati</h3>
    <div class="export-import-buttons">
      <button onclick="exportAllData()">ðŸ“¤ Esporta CSV</button>
      <button onclick="document.getElementById('import-file').click()">ðŸ“¥ Importa CSV</button>
    </div>
    <input type="file" id="import-file" accept=".csv" onchange="importData(this)" />
   
  </div>
  <!-- Calendario -->
  <section id="calendar-section" class="active" aria-label="Calendario">
    <h2>Calendario</h2>
    <form id="appointment-form">
      <label for="app-title">Titolo Appuntamento</label>
      <input type="text" id="app-title" required />

      <label for="app-date">Data e Ora</label>
      <input type="datetime-local" id="app-date" required />

      <button type="submit" class="primary">Aggiungi / Aggiorna</button>
    </form>
    <div id="appointments-list"></div>
  </section>

  <!-- Rubrica -->
  <section id="contacts-section" aria-label="Rubrica">
    <h2>Rubrica</h2>

    <label for="filter-category">Filtra per categoria</label>
    <select id="filter-category">
      <option value="">Tutte le categorie</option>
      <option value="Editore">Editore</option>
      <option value="Editor">Editor</option>
      <option value="Redattore">Redattore</option>
      <option value="Responsabile Editoriale">Responsabile Editoriale</option>
      <option value="Grafico">Grafico</option>
      <option value="Illustratore">Illustratore</option>
      <option value="Collaboratore">Collaboratore</option>
      <option value="Risorsa Esterne">Risorsa Esterne</option>
    </select>

    <form id="contact-form">
      <label for="contact-category">Categoria</label>
      <select id="contact-category" required>
        <option value="">Seleziona categoria...</option>
        <option value="Editore">Editore</option>
        <option value="Editor">Editor</option>
        <option value="Redattore">Redattore</option>
        <option value="Responsabile Editoriale">Responsabile Editoriale</option>
        <option value="Grafico">Grafico</option>
        <option value="Illustratore">Illustratore</option>
        <option value="Collaboratore">Collaboratore</option>
        <option value="Risorsa Esterne">Risorsa Esterne</option>
      </select>

      <label for="contact-name">Nome e Cognome</label>
      <input type="text" id="contact-name" required />

      <label for="contact-phone">Numero di Telefono</label>
      <input type="tel" id="contact-phone" />

      <label for="contact-email">Indirizzo Email</label>
      <input type="email" id="contact-email" />

      <label for="contact-address">Indirizzo Ufficio</label>
      <input type="text" id="contact-address" />

      <label for="contact-notes">Note</label>
      <textarea id="contact-notes" rows="3"></textarea>

      <button type="submit" class="primary">Aggiungi / Aggiorna</button>
    </form>
    <div id="contacts-list"></div>
  </section>

  <!-- Lavorazioni -->
  <section id="jobs-section" aria-label="Progetti in corso">
    <h2>Progetti in corso</h2>
    <form id="job-form">
      <label for="job-title">Titolo Lavoro</label>
      <input type="text" id="job-title" required />

      <label for="job-notes">Note</label>
      <textarea id="job-notes" rows="3"></textarea>

      <label for="job-duration">Durata (giorni)</label>
      <input type="number" id="job-duration" min="1" value="1" required />

      <button type="submit" class="primary">Aggiungi / Aggiorna</button>
    </form>
    <div id="jobs-list"></div>
  </section>

</main>
<script>
  // Gestione tab
  const tabs = {
    'tab-calendar': 'calendar-section',
    'tab-contacts': 'contacts-section',
    'tab-jobs': 'jobs-section'
  };
  for (const tabId in tabs) {
    document.getElementById(tabId).addEventListener('click', () => {
      for (const tId in tabs) {
        document.getElementById(tId).classList.toggle('active', tId === tabId);
        document.getElementById(tabs[tId]).classList.toggle('active', tId === tabId);
      }
    });
  }

  // LocalStorage keys
  const STORAGE_KEYS = {
    APPOINTMENTS: 'pwa_appointments',
    CONTACTS: 'pwa_contacts',
    JOBS: 'pwa_jobs'
  };

  // Funzioni comuni
  const loadData = (key) => JSON.parse(localStorage.getItem(key) || '[]');
  const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));

  // --- Calendario ---
  const appointmentForm = document.getElementById('appointment-form');
  const appointmentsList = document.getElementById('appointments-list');
  let editingAppointmentId = null;

  function cleanupExpiredAppointments() {
    let appointments = loadData(STORAGE_KEYS.APPOINTMENTS);
    const now = new Date();
    appointments = appointments.filter(app => new Date(app.date) > now);
    saveData(STORAGE_KEYS.APPOINTMENTS, appointments);
  }

  function renderAppointments() {
    cleanupExpiredAppointments();
    let appointments = loadData(STORAGE_KEYS.APPOINTMENTS);
    appointments.sort((a, b) => new Date(a.date) - new Date(b.date));

    if (appointments.length === 0) {
      appointmentsList.innerHTML = '<p>Nessun appuntamento.</p>';
      return;
    }
    appointmentsList.innerHTML = '';
    appointments.forEach((app, index) => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <strong>${app.title}</strong><br/>
        <small>${new Date(app.date).toLocaleString()}</small>
        <div class="item-actions">
          <button onclick="editAppointment(${index})">Modifica</button>
          <button class="danger" onclick="deleteAppointment(${index})">Elimina</button>
        </div>`;
      appointmentsList.appendChild(div);
    });
  }

  function editAppointment(index) {
    const appointments = loadData(STORAGE_KEYS.APPOINTMENTS);
    const app = appointments[index];
    editingAppointmentId = index;
    appointmentForm['app-title'].value = app.title;
    appointmentForm['app-date'].value = app.date;
  }

  function deleteAppointment(index) {
    if (!confirm("Sei sicuro di voler eliminare questo appuntamento?")) return;
    let appointments = loadData(STORAGE_KEYS.APPOINTMENTS);
    appointments.splice(index, 1);
    saveData(STORAGE_KEYS.APPOINTMENTS, appointments);
    renderAppointments();
  }

  appointmentForm.addEventListener('submit', e => {
    e.preventDefault();
    let appointments = loadData(STORAGE_KEYS.APPOINTMENTS);
    const newEntry = {
      title: appointmentForm['app-title'].value.trim(),
      date: appointmentForm['app-date'].value
    };
    if (editingAppointmentId !== null) {
      appointments[editingAppointmentId] = newEntry;
      editingAppointmentId = null;
    } else {
      appointments.push(newEntry);
    }
    saveData(STORAGE_KEYS.APPOINTMENTS, appointments);
    appointmentForm.reset();
    renderAppointments();
  });

  // --- Rubrica ---
  const contactForm = document.getElementById('contact-form');
  const contactsList = document.getElementById('contacts-list');
  const filterCategory = document.getElementById('filter-category');
  let editingContactId = null;

  function renderContacts() {
    let contacts = loadData(STORAGE_KEYS.CONTACTS);
    const selectedCategory = filterCategory.value;
    if (selectedCategory) {
      contacts = contacts.filter(c => c.category === selectedCategory);
    }
    contacts.sort((a, b) => a.name.localeCompare(b.name, 'it', { sensitivity: 'base' }));

    if (contacts.length === 0) {
      contactsList.innerHTML = '<p>Nessun contatto.</p>';
      return;
    }
    contactsList.innerHTML = '';
    contacts.forEach((contact, index) => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <strong>[${contact.category}] ${contact.name}</strong><br/>
        <small>Tel: ${contact.phone || '-'} | Email: ${contact.email || '-'}</small><br/>
        <small>Indirizzo: ${contact.address || '-'}</small><br/>
        <small>Note: ${contact.notes || '-'}</small>
        <div class="item-actions">
          <button onclick="editContact(${index})">Modifica</button>
          <button class="danger" onclick="deleteContact(${index})">Elimina</button>
        </div>`;
      contactsList.appendChild(div);
    });
  }

  function editContact(index) {
    const contacts = loadData(STORAGE_KEYS.CONTACTS);
    const c = contacts[index];
    editingContactId = index;
    contactForm['contact-category'].value = c.category;
    contactForm['contact-name'].value = c.name;
    contactForm['contact-phone'].value = c.phone || '';
    contactForm['contact-email'].value = c.email || '';
    contactForm['contact-address'].value = c.address || '';
    contactForm['contact-notes'].value = c.notes || '';
  }

  function deleteContact(index) {
    if (!confirm("Sei sicuro di voler eliminare questo contatto?")) return;
    let contacts = loadData(STORAGE_KEYS.CONTACTS);
    contacts.splice(index, 1);
    saveData(STORAGE_KEYS.CONTACTS, contacts);
    renderContacts();
  }

  contactForm.addEventListener('submit', e => {
    e.preventDefault();
    let contacts = loadData(STORAGE_KEYS.CONTACTS);
    const newContact = {
      category: contactForm['contact-category'].value,
      name: contactForm['contact-name'].value.trim(),
      phone: contactForm['contact-phone'].value.trim(),
      email: contactForm['contact-email'].value.trim(),
      address: contactForm['contact-address'].value.trim(),
      notes: contactForm['contact-notes'].value.trim()
    };
    if (editingContactId !== null) {
      contacts[editingContactId] = newContact;
      editingContactId = null;
    } else {
      contacts.push(newContact);
    }
    saveData(STORAGE_KEYS.CONTACTS, contacts);
    contactForm.reset();
    renderContacts();
  });

  filterCategory.addEventListener('change', () => {
    renderContacts();
  });

  // --- Lavorazioni in corso ---
  const jobForm = document.getElementById('job-form');
  const jobsList = document.getElementById('jobs-list');
  let editingJobId = null;

  function renderJobs() {
    const jobs = loadData(STORAGE_KEYS.JOBS);
    if (jobs.length === 0) {
      jobsList.innerHTML = '<p>Nessuna lavorazione in corso.</p>';
      return;
    }
    jobsList.innerHTML = '';
    jobs.forEach((job, index) => {
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <strong>${job.title}</strong> - durata: ${job.duration} giorn${job.duration > 1 ? 'i' : ''}<br/>
        <small>Note: ${job.notes || '-'}</small>
        <div class="item-actions">
          <button onclick="editJob(${index})">Modifica</button>
          <button class="danger" onclick="deleteJob(${index})">Elimina</button>
        </div>`;
      jobsList.appendChild(div);
    });
  }

  function editJob(index) {
    const jobs = loadData(STORAGE_KEYS.JOBS);
    const job = jobs[index];
    editingJobId = index;
    jobForm['job-title'].value = job.title;
    jobForm['job-notes'].value = job.notes || '';
    jobForm['job-duration'].value = job.duration;
  }

  function deleteJob(index) {
    if (!confirm("Sei sicuro di voler eliminare questa lavorazione?")) return;
    let jobs = loadData(STORAGE_KEYS.JOBS);
    jobs.splice(index, 1);
    saveData(STORAGE_KEYS.JOBS, jobs);
    renderJobs();
  }

  jobForm.addEventListener('submit', e => {
    e.preventDefault();
    let jobs = loadData(STORAGE_KEYS.JOBS);
    const newJob = {
      title: jobForm['job-title'].value.trim(),
      notes: jobForm['job-notes'].value.trim(),
      duration: parseInt(jobForm['job-duration'].value, 10)
    };
    if (editingJobId !== null) {
      jobs[editingJobId] = newJob;
      editingJobId = null;
    } else {
      jobs.push(newJob);
    }
    saveData(STORAGE_KEYS.JOBS, jobs);
    jobForm.reset();
    renderJobs();
  });

  // Avvio
  renderAppointments();
  renderContacts();
  renderJobs();

  // Registrazione service worker
  init();
  if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('SW registrato'))
    .catch(err => console.error('SW errore:', err));
}
// Funzioni per Export/Import CSV - DA AGGIUNGERE AL JavaScript ESISTENTE

function escapeCSV(field) {
  if (field === null || field === undefined) return '';
  const str = String(field);
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

function exportAllData() {
  try {
    const appointments = loadData(STORAGE_KEYS.APPOINTMENTS);
    const contacts = loadData(STORAGE_KEYS.CONTACTS);
    const jobs = loadData(STORAGE_KEYS.JOBS);

    let csvContent = '';
    
    // Header generale
    csvContent += 'TIPO,TITOLO,DATA_ORA,CATEGORIA,NOME,TELEFONO,EMAIL,INDIRIZZO,NOTE,DURATA_GIORNI\n';
    
    // Appuntamenti
    appointments.forEach(app => {
      csvContent += `APPUNTAMENTO,${escapeCSV(app.title)},${escapeCSV(app.date)},,,,,,\n`;
    });
    
    // Contatti
    contacts.forEach(contact => {
      csvContent += `CONTATTO,,${escapeCSV(contact.category)},${escapeCSV(contact.name)},${escapeCSV(contact.phone)},${escapeCSV(contact.email)},${escapeCSV(contact.address)},${escapeCSV(contact.notes)},\n`;
    });
    
    // Progetti
    jobs.forEach(job => {
      csvContent += `PROGETTO,${escapeCSV(job.title)},,,,,,,${escapeCSV(job.notes)},${job.duration}\n`;
    });

    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `consulente_editoriale_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    alert('Dati esportati con successo!');
  } catch (error) {
    console.error('Errore durante l\'esportazione:', error);
    alert('Errore durante l\'esportazione dei dati');
  }
}

function parseCSV(text) {
  const lines = text.split('\n');
  const result = [];
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    const fields = [];
    let current = '';
    let inQuotes = false;
    
    for (let j = 0; j < line.length; j++) {
      const char = line[j];
      if (char === '"') {
        if (inQuotes && line[j + 1] === '"') {
          current += '"';
          j++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        fields.push(current);
        current = '';
      } else {
        current += char;
      }
    }
    fields.push(current);
    result.push(fields);
  }
  
  return result;
}

function importData(input) {
  const file = input.files[0];
  if (!file) return;
  
  if (!confirm('L\'importazione sostituirÃ  tutti i dati esistenti. Continuare?')) {
    input.value = '';
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const csvData = parseCSV(e.target.result);
      const appointments = [];
      const contacts = [];
      const jobs = [];
      
      // Salta l'header
      for (let i = 1; i < csvData.length; i++) {
        const row = csvData[i];
        if (row.length < 1) continue;
        
        const type = row[0];
        
        if (type === 'APPUNTAMENTO') {
          appointments.push({
            title: row[1] || '',
            date: row[2] || ''
          });
        } else if (type === 'CONTATTO') {
          contacts.push({
            category: row[2] || '',
            name: row[3] || '',
            phone: row[4] || '',
            email: row[5] || '',
            address: row[6] || '',
            notes: row[7] || ''
          });
        } else if (type === 'PROGETTO') {
          jobs.push({
            title: row[1] || '',
            notes: row[8] || '',
            duration: parseInt(row[9]) || 1
          });
        }
      }
      
      // Salva i dati
      saveData(STORAGE_KEYS.APPOINTMENTS, appointments);
      saveData(STORAGE_KEYS.CONTACTS, contacts);
      saveData(STORAGE_KEYS.JOBS, jobs);
      
      // Aggiorna le visualizzazioni
      renderAppointments();
      renderContacts();
      renderJobs();
      
      alert(`Importazione completata!\nAppuntamenti: ${appointments.length}\nContatti: ${contacts.length}\nProgetti: ${jobs.length}`);
      
    } catch (error) {
      console.error('Errore durante l\'importazione:', error);
      alert('Errore durante l\'importazione del file CSV');
    }
    
    input.value = '';
  };
  
  reader.readAsText(file, 'UTF-8');
}
</script>
</body>
</html>
