<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respirazione Wim Hof</title>
    <link rel="manifest" href="./manifest.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .tab-button {
            transition: all 0.3s ease;
            position: relative;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background-color: #F26722;
            border-radius: 1px;
        }
        .btn-double-click-warning {
            transition: transform 0.2s ease-in-out;
            transform: scale(0.9);
            opacity: 0.8;
        }
        /* Smaller history panels */
        .history-card { padding: 0.5rem; border-radius: 0.5rem; }
        .history-session { padding: 0.5rem; margin: 0.25rem 0; border-radius: 0.5rem; font-size: 0.875rem; }
    </style>
</head>
<body class="bg-black text-gray-300 min-h-screen flex flex-col">
    <header class="py-6 px-4 text-center">
        <h1 class="text-3xl font-bold text-orange-400">Respirazione Wim Hof</h1>
        <p class="text-gray-400 mt-2">Tieni traccia della tua pratica</p>
    </header>

    <div id="main-content" class="flex-grow flex flex-col p-4 overflow-auto">
        <div id="tab-pratica" class="tab-content">
            <div id="settings-view" class="flex flex-col space-y-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                    <label for="cycles" class="block text-gray-400 font-bold mb-2">Numero di Cicli</label>
                    <input type="range" id="cycles" min="2" max="7" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg" oninput="document.getElementById('cycles-value').innerText = this.value">
                    <div class="text-right text-orange-400 mt-1"><span id="cycles-value">3</span> Cicli</div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                    <label for="breaths" class="block text-gray-400 font-bold mb-2">Respiri per Ciclo</label>
                    <input type="range" id="breaths" min="20" max="50" value="30" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('breaths-value').innerText = this.value">
                    <div class="text-right text-orange-400 mt-1"><span id="breaths-value">30</span> Respiri</div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                    <p class="text-gray-400 font-bold mb-2">Velocità di Respirazione</p>
                    <div class="flex justify-between space-x-2">
                        <button class="breathing-speed-btn bg-gray-700 hover:bg-orange-600 active:bg-orange-700 text-gray-300 font-bold py-2 px-4 rounded-xl transition w-full active-speed" data-speed="1300">Veloce</button>
                        <button class="breathing-speed-btn bg-gray-700 hover:bg-orange-600 active:bg-orange-700 text-gray-300 font-bold py-2 px-4 rounded-xl transition w-full" data-speed="2200">Normale</button>
                        <button class="breathing-speed-btn bg-gray-700 hover:bg-orange-600 active:bg-orange-700 text-gray-300 font-bold py-2 px-4 rounded-xl transition w-full" data-speed="3000">Lenta</button>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 flex items-center justify-between">
                    <p class="text-gray-400 font-bold">Suoni Beep</p>
                    <input type="checkbox" id="beep-toggle" class="form-checkbox h-5 w-5 rounded-full text-teal-500 bg-gray-600 border-gray-500" checked>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                    <label for="music-file" class="block text-gray-400 font-bold mb-2">Musica</label>
                    <input type="file" id="music-file" accept="audio/*" class="w-full text-gray-300 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-teal-400 hover:file:bg-gray-600">
                    <p id="music-filename" class="text-xs text-gray-500 mt-2 overflow-hidden overflow-ellipsis whitespace-nowrap">Nessun file selezionato</p>
                </div>

                <button id="start-button" class="mt-4 w-full bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-3 rounded-xl shadow-teal-500/50 transition transform active:scale-95">Inizia Sessione</button>
            </div>

            <div id="practice-view" class="hidden flex flex-col items-center justify-center text-center">
                <div id="status-text" class="text-2xl font-bold mb-4 text-orange-400">Respirazione 1 di 30</div>
                <div id="timer-display" class="text-7xl font-light text-white mb-8">00:00</div>
                <div id="cycle-info" class="text-xl text-gray-400 mb-8">Ciclo 1 di 3</div>
                
                <div id="buttons-container" class="flex flex-col space-y-4 w-full px-4">
                    <button id="next-phase-btn" class="bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-3 rounded-xl shadow-teal-500/50 transition transform active:scale-95">Passa subito a ritenzione</button>
                    <button id="stop-btn" class="bg-gray-700 hover:bg-orange-600 text-gray-300 font-bold py-3 rounded-xl transition opacity-80 btn-double-click-warning">Ferma Sessione</button>
                </div>
            </div>
            
            <div id="results-view" class="hidden flex flex-col space-y-4">
                <h2 class="text-2xl font-bold text-orange-400 text-center">Sessione Completata!</h2>
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                    <h3 class="text-xl font-bold text-gray-300 mb-2">Risultati Apnea</h3>
                    <ul id="apnea-results-list" class="list-disc pl-5 text-gray-400 space-y-1"></ul>
                    <div class="mt-4 text-center">
                        <p class="text-lg font-bold text-teal-400">Apnea Media: <span id="apnea-avg">0</span></p>
                    </div>
                </div>
                <button id="save-session-btn" class="bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-3 rounded-xl shadow-teal-500/50 transition transform active:scale-95">Salva Sessione</button>
            </div>
        </div>

        <div id="tab-statistiche" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-orange-400 text-center mb-4">Statistiche</h2>
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
                <p class="text-gray-400 text-center mb-2">Apnea più Lunga e Media del Mese</p>
                <div class="relative h-64 w-full">
                    <canvas id="apneaChart"></canvas>
                </div>
                <div class="flex justify-center space-x-4 mt-4">
                    <button id="export-btn" class="bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-2 px-4 rounded-xl">Esporta CSV</button>
                    <input type="file" id="import-file" accept=".csv" class="hidden">
                    <button id="import-btn" class="bg-orange-500 hover:bg-orange-600 text-gray-900 font-bold py-2 px-4 rounded-xl">Importa CSV</button>
                </div>
                <div id="longest-apnea-display" class="text-center mt-4 text-teal-400 font-bold"></div>
            </div>
            <div id="chart-nodata" class="hidden text-center text-gray-500 mt-4">
                Nessun dato di apnea per il grafico.
            </div>
        </div>

        <div id="tab-cronologia" class="tab-content hidden">
            <h2 class="text-2xl font-bold text-orange-400 text-center mb-4">Cronologia</h2>
            <button id="add-manual-session-btn" class="mb-4 w-full bg-orange-500 hover:bg-orange-600 text-gray-900 font-bold py-2 rounded-xl transition transform active:scale-95">Aggiungi Sessione Manualmente</button>
            <div id="history-list" class="space-y-4">
                </div>
            <div id="history-nodata" class="hidden text-center text-gray-500 mt-4">
                Nessuna sessione trovata.
            </div>
        </div>

        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 max-w-sm w-full">
                <p class="text-center text-gray-300 text-lg mb-6">Sei sicuro di voler eliminare questa sessione?</p>
                <div class="flex justify-around space-x-4">
                    <button id="confirm-delete-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-xl transition w-full">Sì, Elimina</button>
                    <button id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-xl transition w-full">Annulla</button>
                </div>
            </div>
        </div>

        <div id="manual-entry-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 max-w-sm w-full">
                <h3 class="text-xl font-bold text-orange-400 text-center mb-4">Aggiungi Sessione Manuale</h3>
                <div class="space-y-4">
                    <div>
                        <label for="manual-date" class="block text-gray-400 font-bold">Data e Ora</label>
                        <input type="datetime-local" id="manual-date" class="w-full mt-1 p-2 bg-gray-700 rounded-lg text-gray-300 border border-gray-600">
                    </div>
                    <div>
                        <label for="manual-cycles" class="block text-gray-400 font-bold">Cicli completati</label>
                        <input type="number" id="manual-cycles" min="1" class="w-full mt-1 p-2 bg-gray-700 rounded-lg text-gray-300 border border-gray-600" value="3">
                    </div>
                    <div>
                        <label for="manual-apneas" class="block text-gray-400 font-bold">Tempi di Apnea (in secondi, separati da virgola)</label>
                        <textarea id="manual-apneas" rows="3" class="w-full mt-1 p-2 bg-gray-700 rounded-lg text-gray-300 border border-gray-600" placeholder="es. 90, 110, 135"></textarea>
                    </div>
                </div>
                <div class="flex justify-around space-x-4 mt-6">
                    <button id="save-manual-btn" class="bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-2 px-4 rounded-xl transition w-full">Salva</button>
                    <button id="cancel-manual-btn" class="bg-gray-600 hover:bg-gray-700 text-gray-300 font-bold py-2 px-4 rounded-xl transition w-full">Annulla</button>
                </div>
            </div>
        </div>
        
        <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 max-w-sm w-full">
                <p id="notification-text" class="text-center text-gray-300 text-lg mb-6"></p>
                <div class="flex justify-center">
                    <button id="notification-ok-btn" class="bg-teal-500 hover:bg-teal-600 text-gray-900 font-bold py-2 px-4 rounded-xl transition w-full max-w-[120px]">OK</button>
                </div>
            </div>
        </div>

    </div>

    <nav class="bg-gray-900 border-t border-gray-700 shadow-xl">
        <div class="flex justify-around py-2">
            <button id="tab-pratica-btn" class="tab-button active text-gray-400 py-2 px-4 flex-1 text-center font-bold">Pratica</button>
            <button id="tab-statistiche-btn" class="tab-button text-gray-400 py-2 px-4 flex-1 text-center font-bold">Statistiche</button>
            <button id="tab-cronologia-btn" class="tab-button text-gray-400 py-2 px-4 flex-1 text-center font-bold">Cronologia</button>
        </div>
    </nav>

    <script>
        // --- Utility e selettori ---
        const tabContents = document.querySelectorAll('.tab-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        const startButton = document.getElementById('start-button');
        const nextPhaseBtn = document.getElementById('next-phase-btn');
        const stopBtn = document.getElementById('stop-btn');
        const statusText = document.getElementById('status-text');
        const timerDisplay = document.getElementById('timer-display');
        const cycleInfo = document.getElementById('cycle-info');
        const apneaResultsList = document.getElementById('apnea-results-list');
        const apneaAvgDisplay = document.getElementById('apnea-avg');
        const saveSessionBtn = document.getElementById('save-session-btn');
        const historyList = document.getElementById('history-list');
        const historyNoData = document.getElementById('history-nodata');
        const chartNoData = document.getElementById('chart-nodata');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationText = document.getElementById('notification-text');
        const notificationOkBtn = document.getElementById('notification-ok-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFile = document.getElementById('import-file');
        const longestApneaDisplay = document.getElementById('longest-apnea-display');
        const userIdText = document.createElement('div');
        
        // Nuovi selettori per l'inserimento manuale
        const addManualSessionBtn = document.getElementById('add-manual-session-btn');
        const manualEntryModal = document.getElementById('manual-entry-modal');
        const saveManualBtn = document.getElementById('save-manual-btn');
        const cancelManualBtn = document.getElementById('cancel-manual-btn');
        const manualDateInput = document.getElementById('manual-date');
        const manualCyclesInput = document.getElementById('manual-cycles');
        const manualApneasInput = document.getElementById('manual-apneas');

        // Session state (unchanged behavior)
        let currentSession = {
            breaths: 30,
            speed: 2200,
            cycles: 3,
            apneaTimes: [],
            isBeepEnabled: true,
            completedCycles: 0,
        };

        let state = {
            currentCycle: 1,
            currentBreath: 0,
            isBreathing: false,
            isApnea: false,
            isRecovery: false,
            breathingInterval: null,
            apneaStartTime: 0,
            apneaInterval: null,
            recoveryTimer: null,
            doubleClickTimeout: null,
        };

        let audioCtx;
        let musicAudio = new Audio();

        // --- IndexedDB (local only, Firebase removed) ---
        const dbName = 'wimhof_app_db';
        const storeName = 'sessions';
        let idb;

        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (event) => {
                    idb = event.target.result;
                    resolve(idb);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function saveToIndexedDB(session) {
            return new Promise((resolve, reject) => {
                const transaction = idb.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(session);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getSessionsFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const transaction = idb.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function deleteSessionFromIndexedDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = idb.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(Number(id));
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // --- Helpers ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function playBeep(frequency, duration) {
            if (!currentSession.isBeepEnabled) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration / 1000);
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + duration / 1000);
        }

        function showNotification(message) {
            notificationText.innerText = message;
            notificationModal.classList.remove('hidden');
        }

        // --- Practice logic (kept from original) ---
        async function startBreathing() {
            if (musicAudio.src) {
                try { await musicAudio.play(); } catch (e) { /* ignore */ }
            }
            statusText.innerText = "Respirazione";
            timerDisplay.innerText = `${state.currentBreath} di ${currentSession.breaths}`;
            state.isBreathing = true;
            state.isApnea = false;
            state.isRecovery = false;
            state.currentBreath = 0;
            updateCycleInfo();
            updatePracticeButtons();

            state.breathingInterval = setInterval(() => {
                handleBeepsDuringPractice();
                state.currentBreath++;
                timerDisplay.innerText = `${state.currentBreath} di ${currentSession.breaths}`;
                if (state.currentBreath >= currentSession.breaths) {
                    clearInterval(state.breathingInterval);
                    enterApnea();
                }
            }, currentSession.speed);
        }

        function handleBeepsDuringPractice() {
            if (!currentSession.isBeepEnabled) return;
            if (state.isBreathing) {
                if (currentSession.breaths - state.currentBreath <= 3 && state.currentBreath < currentSession.breaths) {
                    playBeep(440, 100);
                }
            } else if (state.isApnea) {
                const apneaTime = (Date.now() - state.apneaStartTime) / 1000;
                if (apneaTime >= 60 && Math.floor(apneaTime) % 60 === 0) {
                    playBeep(880, 200);
                }
            } else if (state.isRecovery) {
                const recoveryTime = 25 - Math.floor((Date.now() - state.recoveryStartTime) / 1000);
                if (recoveryTime >= 0 && recoveryTime <= 3) {
                    playBeep(440, 100);
                }
            }
        }

        function enterApnea() {
            playBeep(600, 300);
            statusText.innerText = "Ritenzione";
            state.isBreathing = false;
            state.isApnea = true;
            state.apneaStartTime = Date.now();
            timerDisplay.innerText = "00:00";
            updatePracticeButtons();

            state.apneaInterval = setInterval(() => {
                const timeElapsed = (Date.now() - state.apneaStartTime) / 1000;
                timerDisplay.innerText = formatTime(timeElapsed);
                handleBeepsDuringPractice();
            }, 1000);
        }

        function enterRecovery() {
            clearInterval(state.apneaInterval);
            const apneaDuration = (Date.now() - state.apneaStartTime) / 1000;
            currentSession.apneaTimes.push(apneaDuration);
            state.isApnea = false;
            state.isRecovery = true;
            statusText.innerText = "Recupero";
            timerDisplay.innerText = "25";
            state.recoveryStartTime = Date.now();
            updatePracticeButtons();

            let recoveryTime = 25;
            state.recoveryTimer = setInterval(() => {
                handleBeepsDuringPractice();
                recoveryTime--;
                timerDisplay.innerText = recoveryTime.toString();
                if (recoveryTime <= 0) {
                    clearInterval(state.recoveryTimer);
                    endCycle();
                }
            }, 1000);
        }

        function endCycle() {
            state.isRecovery = false;
            currentSession.completedCycles++;
            if (currentSession.completedCycles < currentSession.cycles) {
                state.currentCycle++;
                startBreathing();
            } else {
                endSession();
            }
        }

        function endSession() {
            if (musicAudio.src) musicAudio.pause();
            const totalApneas = currentSession.apneaTimes.length;
            const avgApnea = totalApneas > 0 ? currentSession.apneaTimes.reduce((a, b) => a + b, 0) / totalApneas : 0;

            apneaResultsList.innerHTML = '';
            currentSession.apneaTimes.forEach((time, index) => {
                const li = document.createElement('li');
                li.className = 'text-gray-400';
                li.innerText = `Ciclo ${index + 1}: ${formatTime(time)}`;
                apneaResultsList.appendChild(li);
            });
            apneaAvgDisplay.innerText = formatTime(avgApnea);

            currentSession.longestApnea = totalApneas > 0 ? Math.max(...currentSession.apneaTimes) : 0;
            currentSession.averageApnea = avgApnea;

            showResults();
        }

        function stopSessionEarly() {
            clearInterval(state.breathingInterval);
            clearInterval(state.apneaInterval);
            clearInterval(state.recoveryTimer);
            if (musicAudio.src) musicAudio.pause();

            const totalApneas = currentSession.apneaTimes.length;
            const avgApnea = totalApneas > 0 ? currentSession.apneaTimes.reduce((a, b) => a + b, 0) / totalApneas : 0;

            apneaResultsList.innerHTML = '';
            if (totalApneas > 0) {
                currentSession.apneaTimes.forEach((time, index) => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-400';
                    li.innerText = `Ciclo ${index + 1}: ${formatTime(time)}`;
                    apneaResultsList.appendChild(li);
                });
            } else {
                apneaResultsList.innerHTML = '<li class=\"text-gray-500\">Nessun ciclo completato.</li>';
            }
            apneaAvgDisplay.innerText = formatTime(avgApnea);

            currentSession.longestApnea = totalApneas > 0 ? Math.max(...currentSession.apneaTimes) : 0;
            currentSession.averageApnea = avgApnea;

            showResults();
        }

        function showPractice() {
            document.getElementById('settings-view').classList.add('hidden');
            document.getElementById('practice-view').classList.remove('hidden');
            document.getElementById('results-view').classList.add('hidden');
        }

        function showResults() {
            document.getElementById('settings-view').classList.add('hidden');
            document.getElementById('practice-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('hidden');
        }

        function showSettings() {
            document.getElementById('settings-view').classList.remove('hidden');
            document.getElementById('practice-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
        }

        function updateCycleInfo() {
            cycleInfo.innerText = `Ciclo ${state.currentCycle} di ${currentSession.cycles}`;
        }
        
        function updatePracticeButtons() {
            if (state.isBreathing) {
                nextPhaseBtn.innerText = "Passa subito a ritenzione";
                nextPhaseBtn.classList.remove('hidden');
            } else if (state.isApnea) {
                nextPhaseBtn.innerText = "Inizia Recupero";
                nextPhaseBtn.classList.remove('hidden');
            } else {
                nextPhaseBtn.classList.add('hidden');
            }
        }

        // --- Event listeners e UI ---
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                showTab(btn.id.replace('tab-', '').replace('-btn', ''));
            });
        });

        document.querySelectorAll('.breathing-speed-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.breathing-speed-btn').forEach(b => {
                    b.classList.remove('active-speed', 'bg-teal-500', 'text-gray-900');
                    b.classList.add('bg-gray-700', 'text-gray-300');
                });
                btn.classList.add('active-speed', 'bg-teal-500', 'text-gray-900');
                btn.classList.remove('bg-gray-700', 'text-gray-300');
                currentSession.speed = parseInt(btn.dataset.speed);
            });
        });
        document.querySelector('.breathing-speed-btn').click();

        startButton.addEventListener('click', () => {
            const cyclesValue = parseInt(document.getElementById('cycles').value);
            const breathsValue = parseInt(document.getElementById('breaths').value);
            const selectedSpeedBtn = document.querySelector('.breathing-speed-btn.bg-teal-500');
            const beepEnabled = document.getElementById('beep-toggle').checked;

            if (selectedSpeedBtn) {
                currentSession.speed = parseInt(selectedSpeedBtn.dataset.speed);
            }
            currentSession.cycles = cyclesValue;
            currentSession.breaths = breathsValue;
            currentSession.apneaTimes = [];
            currentSession.completedCycles = 0;
            currentSession.isBeepEnabled = beepEnabled;

            state.currentCycle = 1;
            state.currentBreath = 0;

            showPractice();
            startBreathing();
        });

        nextPhaseBtn.addEventListener('click', () => {
            if (state.isBreathing) {
                clearInterval(state.breathingInterval);
                enterApnea();
            } else if (state.isApnea) {
                enterRecovery();
            }
        });

        stopBtn.addEventListener('click', (event) => {
            if (state.doubleClickTimeout) {
                clearTimeout(state.doubleClickTimeout);
                state.doubleClickTimeout = null;
                stopSessionEarly();
            } else {
                stopBtn.classList.remove('btn-double-click-warning');
                stopBtn.innerText = 'Clicca di nuovo per fermare';
                state.doubleClickTimeout = setTimeout(() => {
                    stopBtn.classList.add('btn-double-click-warning');
                    stopBtn.innerText = 'Ferma Sessione';
                    state.doubleClickTimeout = null;
                }, 1000);
            }
        });

        document.body.addEventListener('keyup', (e) => {
            if (document.getElementById('practice-view').classList.contains('hidden')) return;

            if (e.key === ' ' || e.key === 'Enter') {
                if (state.isBreathing) {
                    clearInterval(state.breathingInterval);
                    enterApnea();
                } else if (state.isApnea) {
                    enterRecovery();
                }
            }
        });

        const musicFile = document.getElementById('music-file');
        const musicFilename = document.getElementById('music-filename');
        musicFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                musicFilename.innerText = file.name;
                const fileURL = URL.createObjectURL(file);
                musicAudio.src = fileURL;
                musicAudio.loop = true;
                musicAudio.volume = 0.5;
            } else {
                musicFilename.innerText = "Nessun file selezionato";
                musicAudio.src = '';
            }
        });

        saveSessionBtn.addEventListener('click', async () => {
            const sessionData = {
                date: new Date().toISOString(),
                cycles: currentSession.cycles,
                breaths: currentSession.breaths,
                apneaTimes: currentSession.apneaTimes,
                longestApnea: currentSession.longestApnea || 0,
                averageApnea: currentSession.averageApnea || 0,
                completedCycles: currentSession.completedCycles || 0,
            };

            try {
                await openIndexedDB();
                await saveToIndexedDB(sessionData);
                showNotification('Sessione salvata localmente.');
                // Dopo il salvataggio, ricarica i dati per statistiche/cronologia
                await loadDataAndRender();
                showTab('cronologia');
                showSettings();
            } catch (e) {
                console.error('Errore salvataggio:', e);
                showNotification('Errore durante il salvataggio locale.');
            }
        });

        notificationOkBtn.addEventListener('click', () => {
            notificationModal.classList.add('hidden');
        });

        // --- CRUD IndexedDB per la UI di Cronologia/Statistiche ---
        async function fetchHistory() {
            try {
                await openIndexedDB();
                const sessions = await getSessionsFromIndexedDB();
                // Assicuriamoci che la data sia oggetto Date per la visualizzazione
                const mapped = sessions.map(s => ({ ...s, dateObj: new Date(s.date) })).sort((a,b) => b.dateObj - a.dateObj);
                renderHistory(mapped);
            } catch (e) {
                console.error('Errore recupero cronologia:', e);
                historyNoData.classList.remove('hidden');
            }
        }

        function renderHistory(sessions) {
            if (!sessions || sessions.length === 0) {
                historyNoData.classList.remove('hidden');
                historyList.innerHTML = '';
                return;
            }
            historyNoData.classList.add('hidden');
            historyList.innerHTML = '';

            // Raggruppa per mese (YYYY-MM)
            const groups = {};
            sessions.forEach(s => {
                const key = `${s.dateObj.getFullYear()}-${String(s.dateObj.getMonth()+1).padStart(2,'0')}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(s);
            });

            Object.keys(groups).sort().reverse().forEach(key => {
                const [year, month] = key.split('-');
                const monthName = new Date(year, month-1).toLocaleString('it-IT', { month: 'long', year: 'numeric' });
                const details = document.createElement('details');
                details.className = 'history-card bg-gray-800 p-2 rounded-xl';
                const summary = document.createElement('summary');
                summary.className = 'cursor-pointer p-2 font-bold text-orange-400';
                summary.innerText = monthName;
                details.appendChild(summary);

                groups[key].forEach(s => {
                    const d = s.dateObj;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'history-session bg-gray-700 rounded-lg flex justify-between items-start';
                    wrapper.innerHTML = `
                        <div class="p-2 flex-1">
                            <div class="text-gray-200 font-bold">${d.toLocaleDateString('it-IT')} ${d.toLocaleTimeString('it-IT')}</div>
                            <div class="text-xs text-gray-400">Cicli: ${s.completedCycles} / Respiri: ${s.breaths}</div>
                            <div class="text-teal-400">Apnea media: ${Number(s.averageApnea || 0).toFixed(1)}s</div>
                            <ul class="list-disc ml-4 text-gray-400 mt-1">
                                ${ (s.apneaTimes || []).map((t, i) => `<li>Ciclo ${i+1}: ${Number(t).toFixed(1)}s</li>`).join('') }
                            </ul>
                        </div>
                        <div class="p-2 flex flex-col items-end space-y-2">
                            <button class="delete-btn bg-gray-600 hover:bg-orange-600 text-white font-bold py-1 px-2 rounded-xl" data-id="${s.id}">Elimina</button>
                        </div>
                    `;
                    details.appendChild(wrapper);
                });

                historyList.appendChild(details);
            });
        }

        // Gestione eliminazione
        let sessionToDeleteId = null;
        historyList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                sessionToDeleteId = e.target.dataset.id;
                confirmModal.classList.remove('hidden');
            }
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!sessionToDeleteId) return;
            try {
                await openIndexedDB();
                await deleteSessionFromIndexedDB(sessionToDeleteId);
                showNotification('Sessione eliminata.');
                await loadDataAndRender();
            } catch (e) {
                console.error('Errore eliminazione:', e);
                showNotification('Errore nell\'eliminazione.');
            } finally {
                confirmModal.classList.add('hidden');
                sessionToDeleteId = null;
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            sessionToDeleteId = null;
        });

        // --- Gestione Inserimento Manuale ---
        addManualSessionBtn.addEventListener('click', () => {
            // Pre-popola la data e ora attuali
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            manualDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            manualEntryModal.classList.remove('hidden');
        });

        cancelManualBtn.addEventListener('click', () => {
            manualEntryModal.classList.add('hidden');
            // Resetta i campi
            manualApneasInput.value = '';
        });

        saveManualBtn.addEventListener('click', async () => {
            const dateStr = manualDateInput.value;
            const cyclesStr = manualCyclesInput.value;
            const apneasStr = manualApneasInput.value;

            if (!dateStr || !cyclesStr || !apneasStr) {
                showNotification('Tutti i campi sono obbligatori.');
                return;
            }

            const apneaTimes = apneasStr.split(',').map(s => parseFloat(s.trim()));
            if (apneaTimes.some(isNaN) || apneaTimes.length === 0) {
                showNotification('I tempi di apnea devono essere numeri validi, separati da virgola.');
                return;
            }
            
            const totalApneas = apneaTimes.length;
            const avgApnea = totalApneas > 0 ? apneaTimes.reduce((a, b) => a + b, 0) / totalApneas : 0;
            const longestApnea = totalApneas > 0 ? Math.max(...apneaTimes) : 0;
            const completedCycles = parseInt(cyclesStr);

            const sessionData = {
                date: new Date(dateStr).toISOString(),
                cycles: completedCycles, // Si presume che il numero di cicli inserito sia quello completato
                breaths: 0, // Dati non disponibili da input manuale
                apneaTimes: apneaTimes,
                longestApnea: longestApnea,
                averageApnea: avgApnea,
                completedCycles: completedCycles,
                isManual: true // Flag per distinguere le sessioni manuali
            };

            try {
                await openIndexedDB();
                await saveToIndexedDB(sessionData);
                showNotification('Sessione manuale salvata con successo.');
                manualEntryModal.classList.add('hidden');
                // Ricarica i dati per aggiornare la UI
                await loadDataAndRender();
            } catch (e) {
                console.error('Errore salvataggio sessione manuale:', e);
                showNotification('Errore durante il salvataggio della sessione.');
            }
        });


        // --- Statistiche (IndexedDB only) ---
        let myChart = null;
        async function fetchStats() {
            try {
                await openIndexedDB();
                const sessions = await getSessionsFromIndexedDB();
                const mapped = sessions.map(s => ({ ...s, dateObj: new Date(s.date) })).sort((a,b) => a.dateObj - b.dateObj);
                renderChart(mapped);
            } catch (e) {
                console.error('Errore recupero statistiche:', e);
                if (myChart) myChart.destroy();
                chartNoData.classList.remove('hidden');
            }
        }

        function renderChart(sessions) {
            const ctx = document.getElementById('apneaChart').getContext('2d');
            if (myChart) myChart.destroy();

            if (!sessions || sessions.length === 0) {
                chartNoData.classList.remove('hidden');
                longestApneaDisplay.innerText = '';
                return;
            }
            chartNoData.classList.add('hidden');

            const labels = sessions.map(s => s.dateObj.toLocaleDateString('it-IT'));
            const longest = sessions.map(s => Number(s.longestApnea || 0));
            const average = sessions.map(s => Number(s.averageApnea || 0));

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Apnea Più Lunga (s)', data: longest, backgroundColor: '#F26722' },
                        { label: 'Apnea Media (s)', data: average, backgroundColor: '#008080' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#bbb' } },
                        x: { ticks: { color: '#bbb' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#bbb' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const v = context.raw;
                                    const mmss = formatTime(v);
                                    return `${context.dataset.label}: ${mmss}`;
                                }
                            }
                        }
                    }
                }
            });

            // Apnea più lunga complessiva
            const maxApnea = Math.max(...longest);
            const idx = longest.indexOf(maxApnea);
            const sessionDate = sessions[idx] ? sessions[idx].dateObj.toLocaleDateString('it-IT') : '';
            longestApneaDisplay.innerText = `Apnea più lunga: ${maxApnea.toFixed(1)}s — ${sessionDate}`;
        }

        // --- CSV Export / Import ---
        exportBtn.addEventListener('click', async () => {
            try {
                await openIndexedDB();
                const sessions = await getSessionsFromIndexedDB();
                let csv = 'date_iso,cycles,breaths,apnea_times_pipe,average,longest,completedCycles\\n';
                sessions.forEach(s => {
                    const apneaPipe = (s.apneaTimes || []).join('|');
                    csv += `${s.date},${s.cycles},${s.breaths},"${apneaPipe}",${s.averageApnea || 0},${s.longestApnea || 0},${s.completedCycles || 0}\\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'wimhof_sessions_export.csv';
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('Errore export CSV', e);
                showNotification('Errore durante l\'esportazione CSV.');
            }
        });

        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const text = await file.text();
            const lines = text.split('\\n').filter(l => l.trim());
            // First line header
            lines.slice(1).forEach(async (row) => {
                // Basic split by comma but apneaTimes may be quoted
                const parts = row.split(',');
                if (parts.length < 7) return;
                const date = parts[0];
                const cycles = Number(parts[1]);
                const breaths = Number(parts[2]);
                // apnea times might be quoted with pipes
                const apneaField = parts[3].replace(/^"|"$/g, '');
                const apneaTimes = apneaField ? apneaField.split('|').map(Number) : [];
                const avg = Number(parts[4]) || (apneaTimes.length ? apneaTimes.reduce((a,b)=>a+b,0)/apneaTimes.length : 0);
                const longest = Number(parts[5]) || (apneaTimes.length ? Math.max(...apneaTimes) : 0);
                const completed = Number(parts[6]) || cycles;

                const sessionObj = {
                    date: new Date(date).toISOString(),
                    cycles,
                    breaths,
                    apneaTimes,
                    averageApnea: avg,
                    longestApnea: longest,
                    completedCycles: completed
                };
                try {
                    await openIndexedDB();
                    await saveToIndexedDB(sessionObj);
                } catch (err) { console.error('Errore import', err); }
            });
            // Small delay then reload
            setTimeout(loadDataAndRender, 500);
        });

        // --- Utility per mostrare tab ---
        function showTab(tabId) {
            tabContents.forEach(content => content.classList.add('hidden'));
            tabButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}-btn`).classList.add('active');

            if (tabId === 'statistiche') fetchStats();
            if (tabId === 'cronologia') fetchHistory();
        }

        // --- Load data and initial setup ---
        async function loadDataAndRender() {
            try {
                await openIndexedDB();
                const sessions = await getSessionsFromIndexedDB();
                const mapped = sessions.map(s => ({ ...s, dateObj: new Date(s.date) })).sort((a,b)=>b.dateObj - a.dateObj);
                renderChart(mapped.slice().reverse()); // renderChart expects chronological
                renderHistory(mapped);
            } catch (e) {
                console.error('Errore loadData', e);
            }
        }

        // --- Initialization on load ---
        window.onload = async () => {
            // show default tab pratica
            showTab('pratica');
            await openIndexedDB();
            // set a local user id visible in console (no firebase)
            const localId = 'local-' + (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
            console.log('Local user id:', localId);
            // Preload data for stats/history
            loadDataAndRender();
            // ensure speed button default
            document.querySelector('.breathing-speed-btn').click();
        };

        window.addEventListener('online', () => { /* nothing to sync with remote */ });
        
        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                .register("/sw.js")
                .then((reg) => console.log("Service Worker registrato:", reg))
                .catch((err) => console.error("Errore Service Worker:", err));
            });
        }
    </script>
</body>
</html>
